<!DOCTYPE html>
<html lang="en">
<head>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
    <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
  </head>

  <style>
    body {
      font-family: "Raleway", "Helvetica Neue", helvetica;
    }
    #wrapper {
      position: relative;
      width: 960px;
      height: 720px;
      margin: 0 auto;
    }

    #page-title {
      font-weight: normal;
      font-size: 48px;
      text-align: center;
      margin: 10px 0;
    }

    .counties {
      fill: none;
    }
    .counties path {
      stroke: #fff;
      stroke-width: .25;
      stroke-linejoin: round;
    }
    .counties path:hover {
      fill: #000;
    }

    .states {
      fill: none;
      stroke: #fff;
      stroke-width: 1;
      stroke-linejoin: round;
    }

    .legend .block {
        width: 15px;
        height: 15px;
    }

    #reset {
      position: absolute;
      left: 5px;
      bottom: 65px;
      background-color: white;
    }

    #place-info {
      position: absolute;
      bottom: 65px;
      right: 10px;
      width: 300px;
      height: 175px;
      border: 3px solid black;
      border-radius: 5px;
      background-color: rgba(255,255,255,.9);
      padding: 10px;

      display: none;
    }
    #place-info .name {
      font-size: 24px;
      margin: 0;
    }
    #place-info ul {
      list-style: none;
      margin: 10px 0 0 0;
      padding: 0;
      line-height: 1.5em;
      font-size: 18px;
    }

    .q0-9 { fill:rgb(255,213,213); }
    .q1-9 { fill:rgb(255,170,170); }
    .q2-9 { fill:rgb(255,128,128); }
    .q3-9 { fill:rgb(255,85,85); }
    .q4-9 { fill:rgb(255,42,42); }
    .q5-9 { fill:rgb(255,0,0); }
    .q6-9 { fill:rgb(212,0,0); }
    .q7-9 { fill:rgb(170,0,0);}
    .q8-9 { fill:rgb(128,0,0); }
    .q9-9 { fill:rgb(85,0,0); }

    button {
      padding: 10px 10px 10px 10px;
      background-color: white;
      color: #636363;
      box-shadow: 0 1.5px 0 #e2e2e2;
      border-radius: 3px;
      -moz-border-radius: 3px;
      border: 1.5px solid #c2c2c2;
      font-family: 'Arial';
      text-transform: uppercase;
      font-weight: bold;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
  
  </style>
</head>
<body>
  <div id="wrapper">
    <h1 id="page-title">Wage Theft in the United States</h1>
    <svg id="map" width="960" height="600"></svg>
    <paper-button raised id="reset">Reset Map</paper-button>
    <svg class="legend" width="500">
      <filter id="dropshadow" height="130%">
        <feGaussianBlur in="SourceAlpha" stdDeviation="3"/> <!-- stdDeviation is how much to blur -->
        <feOffset dx="2" dy="2" result="offsetblur"/> <!-- how much to offset -->
        <feMerge>
          <feMergeNode/> <!-- this contains the offset blurred image -->
          <feMergeNode in="SourceGraphic"/> <!-- this contains the element that the filter is applied to -->
        </feMerge>
      </filter>

      <text x="0" y="12">0 <</text>
      <rect class="block q0-9" x="25"></rect>
      <rect class="block q1-9" x="45"></rect>
      <rect class="block q2-9" x="65"></rect>
      <rect class="block q3-9" x="85"></rect>
      <rect class="block q4-9" x="105"></rect>
      <rect class="block q5-9" x="125"></rect>
      <rect class="block q6-9" x="145"></rect>
      <rect class="block q7-9" x="165"></rect>
      <rect class="block q8-9" x="185"></rect>
      <rect class="block q9-9" x="205"></rect>
      <text x="225" y="12">>1,000,000</text>
    </svg>
    <div id="place-info">
      <h2 class="name">County or City Name</h2>
      <ul>
        <li class="population">Population: ###</li>
        <li class="people-affected">People Affected: ###</li>
        <li class="total-money">Total Money: $#####</li>
      </ul>
    </div>
  </div>
  <script>
    var $reset = $('paper-button[id=reset]').hide()
    var centered;

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var rateById = d3.map();
    var cities = d3.map();
    
    var quantize = d3.scaleQuantize()
        .domain([0, 1000000])
        .range(d3.range(10).map(function(i) { return "q" + i + "-9"; }));

    var projection = d3.geoAlbersUsa()
        .scale(1280)
        .translate([width / 2, height / 2]);

    var path = d3.geoPath()
        .projection(projection);

    var g = svg.append("g");

    d3.queue()
        .defer(d3.json, "us.json")
        .defer(d3.csv, "fips_backwages.csv", function(d) { rateById.set(d.id, +d.amount); })
        .defer(d3.csv, "US_Cities_Lat_LonSmall.csv")
               
        .await(ready);


    function ready(error, us, fips_backwages, cities) {
      if (error) throw error;

      g.append("g")
        .attr("class", "counties")
        .selectAll("path")
          .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("class", function(d) {
            return quantize(rateById.get(d.id));
          })
          .attr("d", path)
          .on("click", clicked);

      g.append("path")
          .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "states")
          .attr("d", path)
          .selectAll("path")
          
          
      console.log(cities)
      g.selectAll("circle")
                  .data(cities)
                  .enter()
                  .append("circle")
                  .each(function (d) {
                      var location = projection([d.longitude, d.latitude]);
                        //console.log(d3.select($(this)))
                        
                        $(this).attr({
                          cx: location[0], cy: location[1],
                                     //r: Math.sqrt(+d.population * 0.000004),
                          r: "0.8",
                          fill:"white",
                                     stroke:"black",
                                     'stroke-width':"0.2",
                          visibility:"hidden"
                      });
                  })
                  
                  
        g.selectAll("text")
                  .data(cities)
                  .enter()
                  .append("text")
                  .each(function (d) {
                        var location = projection([d.longitude, d.latitude]);
                        
                        $(this).attr({ x: location[0]+1,
                                       y: location[1]+0.65,
                                      'font-family':"sans-serif",
                                      'font-size':"2",
                                       fill:"#F1F8E9",
                                       visibility:"hidden",
                                     stroke:"black",
                                     "stroke-width":"0.1",
                                     "font-weight":"bold"
                                     
                                     
                                     })
                                .text(d.name)

                        })

                
    
//      console.log(cities)
      
     /* g.selectAll("circle")
      .data([{"Lat":"37.775","Long":"-122.4183333"}])
        .enter()
        .append("circle")
        .each(function (d) {
              var location = projection([d.Long, d.Lat]);
              console.log(location)
              d3.select(this).attr({
                                   cx: location[0], cy: location[1],
                                   r: "50",
                                   });
              })
              .style({
                     fill: 'blue',
                     opacity: 0.75
                     });

*/

    }

    function clicked(d) {
      $('#place-info').fadeIn('500');

      var x, y, k;

      if (d && centered !== d) {
        var centroid = path.centroid(d);
        x = centroid[0];
        y = centroid[1];
        k = 10;
        centered = d;

        g.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });
  
        g.transition()
        .duration(750)
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px");
        
        d3.selectAll("circle").attr("visibility","visible")
        d3.selectAll("text").attr("visibility","visible")

        $reset.show();
      }
    }

    $reset.on('click', function (e) {
        x = width / 2;
        y = height / 2;
        k = 1;
        centered = null;

      g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

      g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

      d3.selectAll("circle").attr("visibility","hidden")
      d3.selectAll("text").attr("visibility","hidden")

      $reset.hide();
      $('#place-info').fadeOut('500');
    });
  </script>
</body>
